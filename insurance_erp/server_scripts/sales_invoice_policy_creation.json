{
    "name": "Insurance Policy - Create from Proposal",
    "doctype_event": "Sales Invoice",
    "event_frequency": "Before Insert",
    "script_type": "DocType Event",
    "disabled": 0,
    "script": "# Auto-create policy from approved proposal\n\nif doc.is_insurance_policy and doc.source_proposal:\n    # Get the source proposal (Sales Order)\n    proposal = frappe.get_doc('Sales Order', doc.source_proposal)\n    \n    # Validate proposal is approved\n    if not proposal.get('is_insurance_proposal'):\n        frappe.throw('Source Sales Order is not an Insurance Proposal')\n    \n    # Check workflow state if workflow exists\n    workflow_state = proposal.get('workflow_state')\n    if workflow_state and workflow_state not in ['Approved', 'Underwriter Approved']:\n        frappe.throw(f'Can only create policy from Approved proposals. Current state: {workflow_state}')\n    \n    # Generate policy number from settings\n    settings = frappe.get_single('Insurance System Settings')\n    doc.policy_number = frappe.model.naming.make_autoname(settings.policy_naming_series)\n    \n    # Copy vehicle and IDV from proposal\n    doc.vehicle = proposal.vehicle\n    doc.vehicle_idv = proposal.vehicle_idv\n    doc.policy_start_date = proposal.policy_duration_from\n    doc.policy_end_date = proposal.policy_duration_to\n    doc.policy_status = 'Pending Payment'\n    \n    # Freeze coverage snapshot from insurance plan item\n    for item in proposal.items:\n        item_doc = frappe.get_doc('Item', item.item_code)\n        if item_doc.get('is_insurance_plan'):\n            # Copy coverage types to snapshot\n            for coverage in item_doc.get('coverage_types', []):\n                doc.append('coverage_snapshot', {\n                    'coverage_type': coverage.coverage_type,\n                    'limit_type': coverage.limit_type,\n                    'limit_value': coverage.limit_value,\n                    'deductible': coverage.deductible\n                })\n            break"
}